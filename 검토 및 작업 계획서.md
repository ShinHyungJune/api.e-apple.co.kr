# 검토 및 작업 계획서 (수정)

**작업 요청**: 출고처리한 주문건도 관리자에서 주문취소 가능하게 처리
**작성일**: 2025-12-08 (수정: 실제 문제 분석 완료)
**현재 수정사항**: UserSeeder.php 테스트 계정 추가

## 1. 현재 상황 분석 (수정)

### 1.1 수정된 파일 검토
- **database/seeders/UserSeeder.php**: 테스트 계정 추가
  - 논리적 오류 없음 (단순 시더 데이터 추가)
  - 작업 요청과 직접적 연관성 없음

### 1.2 실제 문제 발견
- **관리자에서 "주문성공(출고처리완료)" 상태 주문의 취소 버튼이 표시되지 않음**
- 백엔드에서는 `DELIVERY_PREPARING` 상태를 취소 가능 상태로 정의했지만
- 프론트엔드에서 `can_cancel` 필드가 `false`가 되어 취소 버튼이 숨겨짐

## 2. 실제 문제 분석

### 2.1 can_cancel 필드 생성 로직 문제
```php
// app/Http/Resources/OrderResource.php (23-24라인)
'can_cancel' => in_array($this->status, OrderStatus::CAN_ORDER_CANCELS)
    && $this->orderProducts->every(fn($e) => in_array($e->status, OrderStatus::CAN_ORDER_CANCELS)),
```

**문제점**:
- **Order 상태**와 **모든 OrderProduct 상태** 모두 `CAN_ORDER_CANCELS`에 있어야 함
- 출고처리 과정에서 Order와 OrderProduct 상태 불일치 발생
- 결과적으로 `can_cancel = false`가 되어 프론트엔드에서 취소 버튼 숨김

### 2.2 현재 취소 가능 상태 정의
```php
// app/Enums/OrderStatus.php
const CAN_ORDER_CANCELS = [
    self::PAYMENT_COMPLETE,      // 결제완료
    self::DELIVERY_PREPARING     // 배송준비중 (출고처리완료)
];
```

### 2.3 상태 불일치 발생 시나리오
1. **Order는 DELIVERY_PREPARING, 일부 OrderProduct는 PAYMENT_COMPLETE**
2. **Order는 PAYMENT_COMPLETE, 일부 OrderProduct는 DELIVERY_PREPARING**
3. **일부 OrderProduct가 DELIVERY 이상 상태로 변경됨**

## 3. 핵심 문제점 및 해결 방향

### 3.1 핵심 문제점

#### A. can_cancel 필드 로직 오류 (위험도: 높음)
**문제**: OrderResource의 can_cancel 계산 로직이 너무 엄격함
- Order 상태와 **모든** OrderProduct 상태가 CAN_ORDER_CANCELS에 있어야 함
- 출고처리 과정에서 상태 동기화 문제로 false가 됨

**영향범위**:
- app/Http/Resources/OrderResource.php:23-24 (can_cancel 필드 생성)
- 프론트엔드에서 취소 버튼 표시 안됨

#### B. 결제 취소 처리 한계 (위험도: 중간)
**문제**: 배송중인 주문의 아임포트 결제 취소 실패 가능성
```php
// 현재 로직: 결제 취소 실패시 전체 프로세스 중단
if (!$result['response']) abort(403, $result['message']);
```

**대안 필요사항**:
- 수동 환불 처리 상태 추가
- 관리자 알림 시스템
- 부분 환불 처리 로직

#### C. 상태 동기화 문제 (위험도: 중간)
**문제**: Order와 OrderProduct 상태 불일치 가능성
- 개별 상품 취소시 주문 전체 상태 미반영
- 혼합 상태에서의 비즈니스 로직 처리 애매모호

### 3.2 수정 시 고려사항

#### A. 재고 관리 정합성
```php
// Order.cancel() 메서드 - 재고 복원 로직
$this->orderProducts->each(function ($e) {
    $e->productOption()->increment('stock_quantity', $e->quantity);
});
```
**위험**: 이미 배송된 상품의 재고가 잘못 복원될 수 있음

#### B. 쿠폰/적립금 반환 정정성
```php
// 사용한 쿠폰 반환
if ($this->user_coupon_id > 0) {
    $coupon = auth()->user()->coupons()->wherePivot('id', $this->user_coupon_id)->first();
    $coupon->pivot->update(['order_id' => null, 'used_at' => null]);
}
```
**위험**: 배송 완료 후 취소시 쿠폰 반환 정책 명확화 필요

## 4. 권장 작업 계획 (우선순위별)

### 4.1 1단계: can_cancel 로직 수정 (급함 - 즉시 수정 필요)
**파일**: `app/Http/Resources/OrderResource.php`

**현재 문제 로직**:
```php
'can_cancel' => in_array($this->status, OrderStatus::CAN_ORDER_CANCELS)
    && $this->orderProducts->every(fn($e) => in_array($e->status, OrderStatus::CAN_ORDER_CANCELS)),
```

**수정 방안 A (보수적)**:
```php
'can_cancel' => $this->canOrderCancel(), // Order 모델의 기존 메서드 사용
```

**수정 방안 B (유연한)**:
```php
'can_cancel' => in_array($this->status, OrderStatus::CAN_ORDER_CANCELS)
    && $this->orderProducts->where('status', '!=', OrderStatus::CANCELLATION_COMPLETE->value)->count() > 0,
```

**수정 방안 C (관리자 권한 확장)**:
```php
'can_cancel' => $request->user()?->is_admin
    ? $this->canAdminCancel()  // 새로 만들 메서드
    : $this->canOrderCancel(), // 기존 사용자 권한
```

### 4.2 2단계: 추가 개선사항 (선택사항)

**A. 관리자 전용 취소 권한 확장**
- 배송중(DELIVERY), 배송완료(DELIVERY_COMPLETE) 상태까지 취소 허용
- OrderStatus.php에 CAN_ADMIN_CANCELS 상수 추가

**B. 상태별 차별화된 취소 처리**
- 배송 전/후에 따른 재고 복원 여부 결정
- 결제 취소 실패시 수동 환불 상태 처리

**C. 부분 취소 시 주문 상태 동기화**
- 일부 OrderProduct만 취소시 Order 상태 업데이트

### 4.3 3단계: 관리자 컨트롤러 수정
**파일**: `app/Http/Controllers/Api/Admin/OrderController.php`

```php
// cancel 메서드 수정
public function cancel(Request $request, $id)
{
    // canOrderCancel() 대신 canAdminCancel() 사용
    $order = Order::with('orderProducts')->findOrFail($id);

    if (!$order->canAdminCancel()) {
        abort(403, '관리자는 배송완료까지의 주문을 취소할 수 있습니다.');
    }

    // 결제 취소 실패시 대체 처리 로직 추가
    // 상태별 차별화된 취소 처리
}
```

### 4.4 4단계: 결제 취소 실패 처리
**새 상태 추가**:
```php
const MANUAL_REFUND_REQUIRED = '수동환불필요';  // 새 상태 추가
```

**환불 처리 개선**:
```php
// 아임포트 취소 실패시 수동 환불 상태로 전환
if (!$result['response']) {
    $order->update(['status' => OrderStatus::MANUAL_REFUND_REQUIRED]);
    // 관리자 알림 발송
    return response()->json(['message' => '취소 처리됨. 수동 환불 필요'], 202);
}
```

## 5. 즉시 수정 권장사항

### 5.1 가장 간단한 수정 (권장)
**파일**: `app/Http/Resources/OrderResource.php` (23-24라인)

**기존 코드**:
```php
'can_cancel' => in_array($this->status, OrderStatus::CAN_ORDER_CANCELS)
    && $this->orderProducts->every(fn($e) => in_array($e->status, OrderStatus::CAN_ORDER_CANCELS)),
```

**수정 코드**:
```php
'can_cancel' => $this->canOrderCancel(),
```

**이유**:
- Order 모델의 기존 `canOrderCancel()` 메서드 사용
- 이미 검증된 로직이므로 안전함
- 현재 문제(상태 불일치)를 즉시 해결

### 5.2 테스트 방법
1. 관리자에서 결제 완료 주문 출고 처리
2. 해당 주문에서 취소 버튼이 표시되는지 확인
3. 취소 버튼 클릭하여 정상 취소되는지 확인

### 5.3 예상 효과
- **"주문성공(출고처리완료)" 상태에서 취소 버튼 정상 표시**
- 기존 취소 로직과 100% 호환
- 부작용 없음 (기존 Order.canOrderCancel() 메서드 재사용)

## 6. 추가 확장 계획 (선택사항)

향후 더 광범위한 취소 기능이 필요하면:
1. **OrderStatus.php**: CAN_ADMIN_CANCELS 상수 추가 (DELIVERY, DELIVERY_COMPLETE 포함)
2. **Order.php**: canAdminCancel() 메서드 추가
3. **OrderResource.php**: 관리자/사용자 권한 분리

## 7. 최종 권장사항

**🔥 즉시 수정 필요**: OrderResource.php 23-24라인 수정
- 현재 문제 즉시 해결
- 위험도 낮음 (기존 검증된 메서드 사용)
- 작업시간 5분 이내

**📋 장기 계획**: 관리자 취소 권한 확장 (배송중/배송완료 상태까지)
- 비즈니스 요구사항에 따라 결정
- 별도 작업 계획서 작성

---

**검토 완료일**: 2025-12-08
**즉시 수정 권장**: OrderResource.php can_cancel 로직 수정
**다음 단계**: 수정 후 관리자 페이지에서 취소 버튼 표시 확인