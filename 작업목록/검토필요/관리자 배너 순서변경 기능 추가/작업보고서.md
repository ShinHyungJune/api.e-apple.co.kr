# 관리자 배너 순서변경 기능 추가 작업 보고서

## 작업 개요
관리자 사이트에서 배너를 등록/수정할 때 순서(sort_order)를 지정할 수 있도록 기능을 추가했습니다.

## 작업 배경
- 기존에는 `PopBanner`(팝업배너)에만 `sort_order` 필드가 있었고, 일반 `Banner`에는 순서 기능이 없었습니다.
- `Banner`는 최신순(`latest()`)으로만 정렬되어 관리자가 배너 순서를 제어할 수 없는 상태였습니다.
- `PopBanner`의 구현 방식을 참고하여 `Banner`에도 동일한 순서 변경 기능을 추가했습니다.

## 수정한 파일 및 변경 내용

### 백엔드 API (api.e-apple.co.kr)

#### 1. 데이터베이스 마이그레이션
**파일**: `database/migrations/2025_10_30_020709_add_sort_order_to_banners_table.php` (신규 생성)

**변경 내용**:
```php
// up() 메서드
$table->integer('sort_order')->default(0)->comment('정렬 순서')->after('is_active');

// down() 메서드
$table->dropColumn('sort_order');
```

**원리**:
- `banners` 테이블에 `sort_order` 정수 필드를 추가합니다.
- 기본값은 0으로 설정하여 기존 데이터와의 호환성을 유지합니다.
- `is_active` 필드 다음에 배치하여 테이블 구조의 일관성을 유지합니다.
- `down()` 메서드에서 롤백 시 필드를 삭제하도록 구현했습니다.

#### 2. BannerRequest 검증 규칙 추가
**파일**: `app/Http/Requests/BannerRequest.php`

**변경 내용**:
```php
public function rules(): array
{
    return [
        'title' => ['required', 'string'],
        'description' => ['required', 'string'],
        'url' => ['required', 'string'],
        'is_active' => ['nullable', 'boolean'],
        'sort_order' => ['nullable', 'integer'],  // 추가된 라인
        'imgs' => ['nullable', 'array'],
    ];
}
```

**원리**:
- `sort_order` 필드에 대한 검증 규칙을 추가했습니다.
- `nullable`로 설정하여 선택적으로 입력할 수 있도록 했습니다.
- `integer` 타입으로 검증하여 정수값만 허용합니다.
- `PopBannerRequest`와 동일한 방식으로 구현하여 일관성을 유지했습니다.

#### 3. 관리자 BannerController 정렬 적용
**파일**: `app/Http/Controllers/Api/Admin/BannerController.php`

**변경 전**:
```php
public function index(Request $request)
{
    $filters = (array)json_decode($request->input('search'));
    $items = Banner::search($filters)->latest()->paginate($request->itemsPerPage ?? 30);
    return BannerResource::collection($items);
}
```

**변경 후**:
```php
public function index(Request $request)
{
    $filters = (array)json_decode($request->input('search'));
    $items = Banner::search($filters)
        ->orderBy('sort_order', 'asc')
        ->latest()
        ->paginate($request->itemsPerPage ?? 30);
    return BannerResource::collection($items);
}
```

**원리**:
- `orderBy('sort_order', 'asc')`를 추가하여 순서값 오름차순으로 우선 정렬합니다.
- `latest()`는 보조 정렬로 남겨두어 같은 순서값일 경우 최신순으로 정렬됩니다.
- `PopBannerController`와 동일한 정렬 방식을 적용했습니다.

#### 4. 사용자 메인 페이지 배너 정렬 적용
**파일**: `app/Http/Controllers/Api/MainController.php`

**변경 전**:
```php
$items['banners'] = Banner::where('is_active', true)->get()->load('media');
```

**변경 후**:
```php
$items['banners'] = Banner::where('is_active', true)
    ->orderBy('sort_order', 'asc')
    ->get()
    ->load('media');
```

**원리**:
- 사용자가 보는 메인 페이지에서도 배너가 순서대로 표시되도록 정렬을 적용했습니다.
- `orderBy('sort_order', 'asc')`를 추가하여 관리자가 설정한 순서대로 배너가 노출됩니다.
- 활성화된 배너만 가져오는 기존 로직은 유지했습니다.

### 관리자 프론트엔드 (admin.e-apple.co.kr)

#### 5. 배너 목록 페이지에 순서 컬럼 추가
**파일**: `pages/banners/index.vue`

**변경 내용**:
```javascript
headers: [
  {align: 'center', sortable: false, width: '80px', text: '순서', value: 'sort_order'},  // 추가된 라인
  {align: 'center', sortable: false, width: '', text: '제목', value: 'title'},
  // ... 기타 컬럼들
]
```

**원리**:
- 배너 목록 테이블에 `순서` 컬럼을 추가하여 각 배너의 순서값을 확인할 수 있습니다.
- 80px 너비로 설정하여 숫자가 표시되기 충분한 공간을 확보했습니다.

#### 6. 배너 등록/수정 폼에 순서 입력 필드 추가
**파일**: `components/banners/DialogForm.vue`

**변경 내용**:
```vue
<v-row>
  <v-col class="d-flex">
    <v-text-field
      v-model.number="form.sort_order"
      :error-messages="errors.sort_order"
      type="number"
      label="순서"
      placeholder="순서를 입력해주세요. (숫자가 작을수록 먼저 표시됩니다)"
      outlined
      dense
    />
  </v-col>
</v-row>
```

**원리**:
- `v-model.number`를 사용하여 입력값을 자동으로 숫자 타입으로 변환합니다.
- `type="number"`로 설정하여 숫자 입력 UI를 제공합니다.
- placeholder에 설명을 추가하여 관리자가 쉽게 이해할 수 있도록 했습니다.
- 기존 DialogForm의 save() 메서드는 form 객체의 모든 값을 자동으로 FormData에 추가하므로, sort_order도 자동으로 API에 전송됩니다.

## 작동 원리 요약

1. **배너 등록/수정 시**:
   - 관리자가 배너를 등록하거나 수정할 때 `sort_order` 값을 함께 전송합니다.
   - `BannerRequest`에서 검증을 거쳐 유효한 정수값만 허용됩니다.
   - 값이 없으면 기본값 0이 적용됩니다.

2. **배너 목록 조회 시**:
   - 관리자 페이지: `sort_order` 오름차순 → 최신순으로 정렬되어 표시됩니다.
   - 사용자 메인 페이지: 활성화된 배너 중 `sort_order` 오름차순으로 표시됩니다.

3. **순서 변경 방법**:
   - 관리자는 배너 수정 시 `sort_order` 값을 변경하여 순서를 조정할 수 있습니다.
   - 작은 숫자일수록 먼저 표시됩니다. (예: 0, 1, 2, 3...)

## 데이터베이스 변경사항
- **테이블**: `banners`
- **추가된 컬럼**: `sort_order` (integer, default: 0, comment: '정렬 순서')
- **마이그레이션 실행**: 완료 (2025_10_30_020709)

## 기존 데이터 영향
- 기존에 등록된 배너들은 모두 `sort_order = 0`으로 설정됩니다.
- 기존 배너들은 최신순으로 유지되며, 관리자가 필요에 따라 순서를 변경할 수 있습니다.

## 참고한 코드
- `PopBanner` 모델 및 관련 코드를 참고하여 동일한 방식으로 구현했습니다.
- 이를 통해 코드 일관성을 유지하고, 유지보수를 용이하게 했습니다.

## 테스트 권장사항
1. 관리자 페이지에서 배너 등록 시 `sort_order` 값 입력 테스트
2. 배너 수정 시 `sort_order` 값 변경 테스트
3. 관리자 배너 목록에서 순서대로 정렬되는지 확인
4. 사용자 메인 페이지에서 배너가 순서대로 표시되는지 확인
5. `sort_order` 값이 동일한 배너들이 있을 경우 최신순으로 정렬되는지 확인

## 완료 일시
2025-10-30
