# 이벤트 배너 추가 (PopBanner) 작업 보고서

## 작업 일시
2025-09-21

## 작업 내용
메인페이지 옆에 팝업 배너 영역을 추가하기 위한 백엔드 API 개발

## 작업 사항

### 1. 생성된 파일

#### 모델 및 마이그레이션
- `app/Models/PopBanner.php` - PopBanner 모델
- `database/migrations/2025_09_20_161954_create_pop_banners_table.php` - 테이블 마이그레이션

#### 컨트롤러
- `app/Http/Controllers/Api/Admin/PopBannerController.php` - 관리자 API 컨트롤러
- `app/Http/Controllers/Api/PopBannerController.php` - 사용자 API 컨트롤러

#### 리퀘스트 및 리소스
- `app/Http/Requests/PopBannerRequest.php` - 유효성 검사
- `app/Http/Resources/PopBannerResource.php` - API 응답 포맷

### 2. 수정된 파일
- `routes/admin.php` - 관리자 API 라우트 추가
- `routes/api.php` - 사용자 API 라우트 추가

## 구현 내용 상세

### 데이터베이스 구조
```php
- id: 기본키
- title: 제목 (string, required)
- url: 링크 URL (string, nullable)
- started_at: 노출 시작일 (timestamp, required)
- finished_at: 노출 종료일 (timestamp, required)
- is_active: 활성화 여부 (boolean, default: true)
- sort_order: 정렬 순서 (integer, default: 0)
- created_at, updated_at: 타임스탬프
- deleted_at: 소프트 삭제
```

### 주요 기능

#### 1. PopBanner 모델 (`app/Models/PopBanner.php`)
- **Spatie Media Library 연동**: 이미지 업로드 관리
- **이미지 변환**: 썸네일 자동 생성 (300x300, 80% 품질)
- **활성 배너 스코프**: `scopeActive()` - 현재 날짜 기준 활성화된 배너만 조회
- **검색 기능**: 제목 기준 검색
- **img 속성**: 업로드된 이미지 URL 자동 반환

#### 2. 관리자 API (`/api/admin/pop-banners`)
- `GET /` - 팝업 배너 목록 조회 (페이지네이션, 검색 지원)
- `POST /` - 새 팝업 배너 등록
- `GET /{popBanner}` - 팝업 배너 상세 조회
- `PUT /{popBanner}` - 팝업 배너 수정
- `DELETE /{popBanner}` - 팝업 배너 삭제
- `DELETE /images/{media}` - 이미지 삭제

#### 3. 사용자 API (`/api/pop-banners`)
- `GET /` - 활성화된 팝업 배너 목록 조회
  - 노출 기간 내 배너만 반환
  - 정렬 순서: sort_order ASC, created_at DESC
- `GET /{popBanner}` - 팝업 배너 상세 조회
  - 비활성 또는 기간 외 배너는 404 반환

#### 4. 유효성 검사 (`PopBannerRequest`)
- title: 필수, 문자열, 최대 255자
- url: 선택, 문자열, 최대 255자
- started_at: 필수, 날짜
- finished_at: 필수, 날짜, started_at 이후
- is_active: 선택, boolean
- sort_order: 선택, 정수
- img: 선택, 이미지 파일, 최대 10MB

### API 응답 형식

#### 사용자 응답
```json
{
  "id": 1,
  "title": "신규회원 웰컴 해택",
  "url": "https://example.com/event",
  "img": "https://api.e-apple.co.kr/storage/..."
}
```

#### 관리자 응답 (추가 필드)
```json
{
  "id": 1,
  "title": "신규회원 웰컴 해택",
  "url": "https://example.com/event",
  "img": "https://api.e-apple.co.kr/storage/...",
  "is_active": true,
  "started_at": "2025-09-01 00:00:00",
  "finished_at": "2025-09-30 23:59:59",
  "sort_order": 0,
  "created_at": "2025-09-01 10:00:00",
  "updated_at": "2025-09-01 10:00:00"
}
```

## 작업 원리

### 배너 노출 로직
1. `is_active = true` 인 배너만 조회
2. 현재 시간이 `started_at` 이후, `finished_at` 이전인 배너만 노출
3. `sort_order` 오름차순으로 정렬 (작은 값이 먼저)
4. 같은 순서일 경우 최신 등록순으로 정렬

### 이미지 처리
- Spatie MediaLibrary 사용으로 이미지 관리 일원화
- 단일 이미지만 허용 (singleFile 설정)
- 허용 형식: JPEG, PNG, GIF, WebP
- 썸네일 자동 생성으로 성능 최적화

## 테스트 결과
- ✅ 마이그레이션 성공 실행
- ✅ PHP 문법 검사 통과
- ✅ 라우트 정상 등록 확인
- ✅ 모든 API 엔드포인트 생성 확인

## 프론트엔드 연동 가이드

### 사용자 프론트
1. 페이지 로드 시 `GET /api/pop-banners` 호출
2. 받은 배너 리스트를 우측(PC)/하단 슬라이드(모바일)에 표시
3. url이 있는 배너 클릭 시 해당 URL로 이동

### 관리자 프론트
1. 배너 관리 페이지에서 CRUD 기능 구현
2. 이미지 업로드는 FormData로 `img` 필드 전송
3. 날짜 선택기로 노출 기간 설정
4. 정렬 순서 입력으로 표시 순서 제어

## 참고사항
- Banner 모델/컨트롤러를 레퍼런스로 구조 통일
- 모바일에서는 슬라이드 팝업 형태로 구현 필요
- 추후 클릭 통계, A/B 테스트 기능 추가 고려 가능