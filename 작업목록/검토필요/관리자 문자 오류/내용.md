# 관리자 문자 오류 수정 보고서

## 문제 현상
관리자에서 택배사와 송장입력 후 출고 진행 시, 발송되는 문자에 운송장번호가 비어있음

## 원인 분석
`app/Http/Controllers/Api/Admin/OrderProductController.php` update 메서드에서 일괄 처리 시 데이터 조회 타이밍 문제

### 기존 코드 (문제)
```php
if (!empty($data['ids']) && count($data['ids']) > 0) {
    $ids = $data['ids'];
    unset($data['ids']);

    // 문제: 업데이트 전에 조회 (delivery_number가 비어있는 상태)
    $orderProducts = OrderProduct::where('status', OrderStatus::DELIVERY_PREPARING)
        ->whereIn('id', $ids)
        ->get();

    // DB 업데이트 (delivery_number 등 저장)
    OrderProduct::where('status', OrderStatus::DELIVERY_PREPARING)
        ->whereIn('id', $ids)
        ->update($data);

    // SMS 발송 - 업데이트 전에 조회한 데이터 사용 (delivery_number 빈 상태)
    if ($isShippingStart) {
        foreach ($orderProducts as $orderProduct) {
            $this->sendShippingNotification($orderProduct);
        }
    }
}
```

### 문제점
업데이트 **전에** `$orderProducts`를 조회하고, 업데이트 **후에** 그 데이터로 SMS를 발송하여 `delivery_number`가 빈 상태로 문자가 전송됨

## 수정 내용
### 수정된 코드
```php
if (!empty($data['ids']) && count($data['ids']) > 0) {
    $ids = $data['ids'];
    unset($data['ids']);

    // 먼저 DB 업데이트
    OrderProduct::where('status', OrderStatus::DELIVERY_PREPARING)
        ->whereIn('id', $ids)
        ->update($data);

    // 배송 시작 SMS 발송 - 업데이트 후 다시 조회하여 최신 데이터로 발송
    if ($isShippingStart) {
        $orderProducts = OrderProduct::whereIn('id', $ids)->get();
        foreach ($orderProducts as $orderProduct) {
            $this->sendShippingNotification($orderProduct);
        }
    }
}
```

### 수정 원리
1. 먼저 DB 업데이트 실행 (delivery_number 등 저장)
2. SMS 발송이 필요할 때만 업데이트된 데이터를 다시 조회
3. 최신 데이터(delivery_number 포함)로 SMS 발송

## 수정 파일
- `app/Http/Controllers/Api/Admin/OrderProductController.php` (53-68번 줄)

## 테스트 방법
1. 관리자 페이지 > 출고관리 접속
2. 배송준비중 상태의 주문 선택
3. 택배사, 운송장번호 입력 후 배송시작 처리
4. 고객에게 전송된 문자에 운송장번호가 정상 표시되는지 확인
