# 쿠폰 자동 발급 기능 구현 보고서

## 작업 개요
회원가입 시와 첫 주문 시 자동으로 쿠폰을 발급하는 기능 구현

## 구현 내용

### 1. 데이터베이스 수정
- **coupons 테이블에 type_moment 컬럼 추가**
  - 마이그레이션 파일: `2025_09_07_140245_add_type_moment_to_coupons_table.php`
  - nullable string 타입, 인덱스 추가

### 2. 새로 생성한 파일들
- **app/Enums/CouponTypeMoment.php**
  - USER_CREATE: 회원가입
  - ORDER_CREATE_FIRST: 첫 주문
  
- **app/Services/CouponAutoIssueService.php**
  - 쿠폰 자동 발급 로직 담당
  - issueForUserCreate(): 회원가입 쿠폰 발급
  - issueForFirstOrder(): 첫 주문 쿠폰 발급

### 3. 수정한 파일들

#### app/Models/Coupon.php
- type_moment 필드 캐스팅 추가

#### app/Http/Controllers/Api/AuthController.php
- store() 메서드: 회원가입 시 쿠폰 자동 발급 추가

#### app/Http/Controllers/Api/OrderController.php
- paymentComplete() 메서드: 결제 완료 시 첫 주문 쿠폰 발급 추가

#### app/Http/Controllers/Api/Admin/CouponController.php  
- init() 메서드 추가: 관리자에서 type_moment 선택 옵션 제공

## 작동 원리

### 회원가입 쿠폰
1. 사용자가 회원가입 완료
2. AuthController의 store 메서드에서 CouponAutoIssueService 호출
3. type_moment가 'USER_CREATE'인 쿠폰 조회
4. 해당 쿠폰들을 신규 회원에게 자동 발급

### 첫 주문 쿠폰
1. 사용자가 결제 완료
2. OrderController의 paymentComplete 메서드에서 결제 성공 처리
3. 해당 사용자의 첫 주문인지 확인
4. 첫 주문인 경우 type_moment가 'ORDER_CREATE_FIRST'인 쿠폰 발급

## 특징
- 중복 발급 방지 로직 포함
- 첫 주문 확인 시 결제 실패한 주문은 제외
- 로그 기록으로 발급 내역 추적 가능
- 관리자가 쿠폰 생성 시 발급 시점 선택 가능 (선택사항)

## 주의사항
- 마이그레이션 실행 필요: `php artisan migrate`
- 관리자 페이지에서 쿠폰 생성 시 type_moment 필드 추가 필요