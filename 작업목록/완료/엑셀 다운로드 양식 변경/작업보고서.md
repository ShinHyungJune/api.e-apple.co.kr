# 엑셀 다운로드 양식 변경 작업 보고서

## 작업 일시
2025-09-21

## 작업 내용
출고관리 엑셀 다운로드 양식을 "한진 대량 업로드 파일_자사몰 up.xlsx" 형식에 맞게 변경

## 수정 파일
- `app/Exports/OrderProductsExport.php`

## 주요 변경 사항

### 1. 필드 오류 수정
- **문제점**: 기존 코드에서 존재하지 않는 필드명 사용
  - `buyer_phone` → `buyer_contact` (올바른 필드명)
  - `buyer_addr` → `buyer_address` (올바른 필드명)
  - `buyer_addr_detail` → `buyer_address_detail` (올바른 필드명)

### 2. 엑셀 헤더 변경
기존 헤더에서 한진택배 대량발송 양식으로 변경 (참고 엑셀 파일과 동일한 순서):
```
기존: 주문번호, 주문일시, 구매자명, 구매자연락처, 상품명, 옵션, 수량, 단가, 금액, 상태, 택배사, 송장번호, 배송비, 수령인, 수령인연락처, 배송주소, 배송메모, 출고일시
변경: 보내시는 분, 보내시는 분 전화, 보내는분총주소, 받으시는 분, 받으시는 분 전화, 받는분우편번호, 받는분총주소, 내품명1, 수량, 메모1, 내품주문번호1, 순번, 운임Type, 지불조건
```

### 3. 데이터 매핑 변경 (참고 엑셀 순서대로)
- **보내시는 분**: '농업회사법인열매나무' (고정값)
- **보내시는 분 전화**: '055-945-3204' (고정값)
- **보내는분총주소**: '경남 거창군 거창읍 거함대로 3372 서북부경남거점산지유통센터(APC)' (고정값)
- **받으시는 분**: 배송지 이름 또는 구매자명
- **받으시는 분 전화**: 배송지 전화 또는 구매자 연락처
- **받는분우편번호**: 배송지 우편번호 또는 구매자 우편번호
- **받는분총주소**: 배송지 주소 + 상세주소
- **내품명1**: 상품명 + 옵션명
- **수량**: 수량
- **메모1**: 배송 요청사항 또는 메모
- **내품주문번호1**: 주문번호 (merchant_uid)
- **순번**: 자동 증가 번호
- **운임Type, 지불조건**: 비어있는 값

### 4. 엑셀 시트 제목 변경
- 기존: `출고관리_YYYY-MM-DD`
- 변경: `한진택배_대량발송_YYYY-MM-DD`

## 작업 원리

### 데이터 흐름
1. **OrderProduct 모델**에서 주문 상품 정보 조회
2. **Order 모델**과 join하여 주문자/배송지 정보 획득
3. 검색 조건 및 선택된 ID 필터링 적용
4. 한진택배 양식에 맞게 데이터 매핑
5. 엑셀 파일로 출력

### 주요 로직
- **우편번호 처리**: 배송지 우편번호가 없으면 구매자 우편번호 사용
- **연락처 처리**: 배송지 연락처 → 구매자 연락처 → 회원 전화번호 순으로 폴백
- **주소 처리**: 배송지 주소가 없으면 구매자 주소 사용
- **순번 처리**: static 변수를 사용하여 자동 증가

## 테스트 결과
- PHP 문법 검사 통과 (php -l)
- 컴파일 오류 없음

## 주의사항
- 보내시는분 정보는 한진택배 계약 정보와 일치해야 함
- 현재 '농업회사법인열매나무' / '055-945-3204' / '경남 거창군 거창읍 거함대로 3372 서북부경남거점산지유통센터(APC)'로 하드코딩되어 있음
- 필요시 config 파일로 분리 검토 필요
- 엑셀 컬럼 순서가 한진택배 업로드 양식과 정확히 일치해야 함